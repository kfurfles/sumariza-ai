# Deploy workflow - triggered on version tags or manual dispatch
# Builds the application and deploys to VPS via SSH

name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: false
        default: 'production'
        type: choice
        options:
          - production

env:
  DEPLOY_PATH: /var/www/sumariza-ai

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: |
          npm install
          go mod download
          go install github.com/a-h/templ/cmd/templ@latest

      - name: Generate templates
        run: templ generate

      - name: Build CSS
        run: npx tailwindcss -i ./static/css/input.css -o ./static/css/output.css --minify

      - name: Build for Linux
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o bin/sumariza-linux ./cmd/server

      - name: Setup SSH and verify connection
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the private key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Show key fingerprint (safe to display)
          echo "Key fingerprint:"
          ssh-keygen -lf ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH connection successful'"

      - name: Deploy binary via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          source: "bin/sumariza-linux"
          target: ${{ env.DEPLOY_PATH }}
          strip_components: 1

      - name: Deploy config via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          source: "config/"
          target: ${{ env.DEPLOY_PATH }}

      - name: Deploy static via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          source: "static/"
          target: ${{ env.DEPLOY_PATH }}

      - name: Deploy service file via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/sumariza-ai.service"
          target: "/tmp"
          strip_components: 1

      - name: Setup and restart service via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          envs: APP_PORT,CACHE_TTL_MINUTES
          script: |
            set -e
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            
            # Create directory structure
            mkdir -p ${DEPLOY_PATH}/bin
            
            # Move binary to final location
            mv ${DEPLOY_PATH}/sumariza-linux ${DEPLOY_PATH}/bin/sumariza
            chmod +x ${DEPLOY_PATH}/bin/sumariza
            
            # Always recreate .env file from secrets
            echo "Creating .env file..."
            cat > ${DEPLOY_PATH}/.env << EOF
            PORT=${APP_PORT:-3000}
            CACHE_TTL_MINUTES=${CACHE_TTL_MINUTES:-5}
            EOF
            chmod 600 ${DEPLOY_PATH}/.env
            echo ".env created:"
            cat ${DEPLOY_PATH}/.env
            
            # Install/update systemd service from template
            echo "Installing systemd service from template..."
            cp /tmp/sumariza-ai.service /etc/systemd/system/sumariza-ai.service
            
            # Ensure www-data user exists and has permissions
            id -u www-data &>/dev/null || useradd -r -s /bin/false www-data
            chown -R www-data:www-data ${DEPLOY_PATH}
            
            systemctl daemon-reload
            systemctl enable sumariza-ai
            
            # Restart service
            echo "Restarting service..."
            systemctl restart sumariza-ai
            
            # Wait for service to be fully active (max 30 seconds)
            echo "Waiting for service to start..."
            for i in {1..10}; do
              STATUS=$(systemctl is-active sumariza-ai || true)
              echo "Status check $i: $STATUS"
              if [ "$STATUS" = "active" ]; then
                echo "Service is active!"
                exit 0
              fi
              sleep 3
            done
            
            # If we get here, service failed to start
            echo "Service failed to start properly"
            journalctl -u sumariza-ai -n 20 --no-pager
            exit 1
        env:
          APP_PORT: ${{ secrets.APP_PORT }}
          CACHE_TTL_MINUTES: ${{ secrets.CACHE_TTL_MINUTES }}


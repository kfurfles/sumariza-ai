# Deploy workflow - triggered on version tags or manual dispatch
# Builds the application and deploys to VPS via SSH

name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: false
        default: 'production'
        type: choice
        options:
          - production

env:
  DEPLOY_PATH: /var/www/sumariza-ai

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: |
          npm install
          go mod download
          go install github.com/a-h/templ/cmd/templ@latest

      - name: Generate templates
        run: templ generate

      - name: Build CSS
        run: npx tailwindcss -i ./static/css/input.css -o ./static/css/output.css --minify

      - name: Build for Linux
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o bin/sumariza-linux ./cmd/server

      - name: Setup SSH and verify connection
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the private key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Show key fingerprint (safe to display)
          echo "Key fingerprint:"
          ssh-keygen -lf ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH connection successful'"

      - name: Deploy binary via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          source: "bin/sumariza-linux"
          target: ${{ env.DEPLOY_PATH }}
          strip_components: 1

      - name: Deploy config via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          source: "config/"
          target: ${{ env.DEPLOY_PATH }}

      - name: Deploy static via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          source: "static/"
          target: ${{ env.DEPLOY_PATH }}

      - name: Setup and restart service via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          debug: true
          envs: APP_PORT,CACHE_TTL_MINUTES,CHROME_PATH
          script: |
            set -e
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            
            # Move binary to final location
            mkdir -p ${DEPLOY_PATH}/bin
            mv ${DEPLOY_PATH}/sumariza-linux ${DEPLOY_PATH}/bin/sumariza
            chmod +x ${DEPLOY_PATH}/bin/sumariza
            
            # Detect Chrome path if not provided
            if [ -z "${CHROME_PATH}" ]; then
              CHROME_PATH=$(which chromium 2>/dev/null || which chromium-browser 2>/dev/null || echo "/snap/bin/chromium")
            fi
            
            # Always recreate .env file from secrets
            echo "Creating .env file..."
            cat > ${DEPLOY_PATH}/.env << EOF
            PORT=${APP_PORT:-3000}
            CACHE_TTL_MINUTES=${CACHE_TTL_MINUTES:-5}
            CHROME_PATH=${CHROME_PATH}
            EOF
            chmod 600 ${DEPLOY_PATH}/.env
            echo ".env created:"
            cat ${DEPLOY_PATH}/.env
            
            # Install systemd service if not exists
            if [ ! -f "/etc/systemd/system/sumariza-ai.service" ]; then
              echo "Installing systemd service..."
              cat > /etc/systemd/system/sumariza-ai.service << 'SERVICEEOF'
            [Unit]
            Description=Sumariza AI Service
            After=network.target
            
            [Service]
            Type=simple
            User=root
            WorkingDirectory=/var/www/sumariza-ai
            ExecStart=/var/www/sumariza-ai/bin/sumariza
            Restart=always
            RestartSec=5
            EnvironmentFile=/var/www/sumariza-ai/.env
            
            [Install]
            WantedBy=multi-user.target
            SERVICEEOF
              systemctl daemon-reload
              systemctl enable sumariza-ai
              echo "Systemd service installed and enabled"
            fi
            
            # Restart service
            echo "Restarting service..."
            systemctl restart sumariza-ai
            sleep 3
            systemctl is-active sumariza-ai
        env:
          APP_PORT: ${{ secrets.APP_PORT }}
          CACHE_TTL_MINUTES: ${{ secrets.CACHE_TTL_MINUTES }}
          CHROME_PATH: ${{ secrets.CHROME_PATH }}
